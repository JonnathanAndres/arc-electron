<!--
@license
Copyright 2017 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../arc-request-panel/arc-request-panel.html">

<dom-module id="request-workspace">
  <template>
    <style>
    :host {
      display: block;
      @apply --request-workspace;
    }

    .tabs-row {
      background-color: var(--request-workspace-tabs-backgroud-color, rgba(0, 0, 0, 0.05));
      border-bottom: 1px var(--request-workspace-tabs-border-color, #e5e5e5) solid;
    }

    .tabs-row paper-tabs {
      --paper-tabs-content: {
        @apply --arc-font-common-base;
        height: 100%;
        border-bottom: 0 solid transparent;
        font-style: normal;
        color: var(--request-workspace-tabs-color, rgba(0,0,0,0.87));
      };
    }

    .tab-name {
      font-size: 13px;
      margin-right: 8px;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .close-icon {
      color: rgba(0, 0, 0, 0.78);
      border-radius: 50%;
      width: 16px;
      height: 16px;
    }

    .close-icon:hover {
      color: rgba(255, 255, 255, 0.54);
      background-color: #FF8A65;
    }

    .add-request-button {
      width: 40px;
      height: 40px;
      margin-left: 12px;
      cursor: pointer;
    }

    paper-tab.iron-selected {
      background-color: var(--request-workspace-tabs-selected-background-color, rgba(255, 138, 101, 0.08));
    }
    </style>
    <app-route route="{{route}}" pattern="/request/:type/:id/:tab" data="{{requestRoute}}"></app-route>
    <div class="tabs-row">
      <paper-tabs selected="{{selected}}" scrollable>
        <template is="dom-repeat" items="[[activeRequests]]">
          <paper-tab>
            <span class="tab-name">[[_computeTabName(item, item.url)]]</span>
            <iron-icon class="close-icon" icon="arc:close" data-index$="[[index]]" on-tap="_closeRequest"></iron-icon>
          </paper-tab>
        </template>
        <paper-icon-button id="add-request-button" icon="arc:add" on-tap="_addRequestHandler" title="Add new request editor"></paper-icon-button>
      </paper-tabs>
    </div>
    <div id="requestsContainer"></div>
    <!-- <iron-pages id="requests" selected-attribute="opened" selected="[[selected]]" selectable=".panel">
      <template is="dom-repeat" items="{{activeRequests}}" on-dom-change="_panelRendered">
        <arc-request-panel request-panel-id="[[index]]" class="panel" request="{{item}}"></arc-request-panel>
      </template>
    </iron-pages> -->
    <paper-toast text="Can't restore request data. The type is unknown." id="typeMissingToast"></paper-toast>
    <paper-toast text="Request do not exists in local database." id="missingRequestToast"></paper-toast>
  </template>
  <script>
    const {WorkspaceState} = require('./scripts/renderer/workspace-state.js');
    Polymer({
      is: 'request-workspace',

      behaviors: [ArcBehaviors.OpenablePanelBehavior],

      properties: {
        requestRoute: Object,
        // Current route object
        route: Object,
        // List of opened requests
        activeRequests: Array,
        // Currently selected request tab
        selected: {
          type: Number,
          notify: true
        },
        __ready: Boolean,
        // Workspace state manager.
        state: {
          type: WorkspaceState,
          readOnly: true
        },
        // Path to a workspace state file.
        workspaceScript: {
          type: String,
          observer: '_workspaceScriptChanged'
        }
      },
      /**
       * Determines if the worspace has at least one request
       * @type {Boolean}
       */
      get hasRequests() {
        return !!(this.activeRequests && this.activeRequests.length);
      },

      observers: [
        '_openedChanged(_isOpened, __ready)',
        '_routeTabChanged(requestRoute.tab, _isOpened)',
        '_selectedChanged(selected)',
        '_requestsListChanged(activeRequests.*)'
      ],

      listeners: {
        'update-tabs': '_updateTabs'
      },

      created: function() {
        this._restoringWorkspace = true;
      },

      attached: function() {
        this.listen(window, 'selected-environment-changed', '_envChanged');
        if (!this.state) {
          this._setState(new WorkspaceState(this.workspaceScript));
        }
        if (!this.__ready) {
          this.__ready = true;
        }
      },

      detached: function() {
        this.unlisten(window, 'selected-environment-changed', '_envChanged');
      },

      _workspaceScriptChanged: function(script) {
        if (this.activeRequests) {
          this.set('activeRequests', undefined);
        }
        this._setState(new WorkspaceState(script));
        if (this._isOpened) {
          this.restoreWorkspace();
        }
      },

      _openedChanged: function(opened) {
        if (opened && !this.activeRequests) {
          this.restoreWorkspace();
        }
      },
      /**
       * Restores workspace state - list of previously opened requests.
       */
      restoreWorkspace: function() {
        this._restoringWorkspace = true;
        this.state.restore()
        .then((data) => this._worspaceStateRestored(data))
        .then(() => {
          if (!this.activeRequests || !this.activeRequests.length) {
            return this.appendPanel();
          }
        })
        .catch(() => this.appendPanel())
        .then(() => {
          this.fire('workspace-restored', undefined, {
            bubbles: true
          });
          this._restoringWorkspace = false;
        });
      },
      /**
       * Adds new empty panel to the workspace.
       */
      appendPanel: function() {
        var obj = {
          method: 'GET'
        };
        var result;
        if (!this.activeRequests) {
          this.set('activeRequests', [obj]);
          result = 0;
        } else {
          result = this.push('activeRequests', obj);
          result--;
        }
        return result;
      },
      /**
       * Adds a new tab with a request object from passed `obj`.
       *
       * @param {Object} obj Request object to pass to the editor
       * @return {Number} Index of created tab.
       */
      fromObject: function(obj) {
        var index = this.appendPanel();
        this.selected = index;
        Polymer.dom.flush();
        var panel = this._getPanel(this.selected);
        panel.request = obj;
        return this.selected;
      },
      /**
       * Restores workspace state (appends request panels) from the workspace
       * settings.
       *
       * @param {Object} data Workspace settings file.
       * @return {Promise} Promise resolved when all request panels are
       * restored.
       */
      _worspaceStateRestored: function(data) {
        this.set('activeRequests', []);
        this._restoreWorkspaceEnvironment(data);
        if (!data || !data.requests) {
          return Promise.resolve();
        }
        this.set('activeRequests', Array.from(data.requests));
        return Promise.resolve();
        // this.__toRestore = {
        //   requests: Array.from(data.requests),
        //   selected: data.selected
        // };
        // return new Promise((resolve) => {
        //   this.__toRestore.promise = resolve;
        //   this._restoreNext();
        // });
      },
      /**
       * Rleated to `_worspaceStateRestored()` function.
       * Adds new panel if there's anything more to restore. Otherwise
       * it resolves restoring promise. This function works together with
       * `_panelRendered()`.
       */
      _restoreNext: function() {
        if (!this.__toRestore) {
          return;
        }
        if (!this.__toRestore.requests.length) {
          this.setSelectedPanel(this.__toRestore.selected);
          this.__toRestore.promise();
          this.__toRestore = undefined;
          return;
        }
        this.appendPanel();
      },
      /**
       * Sets currently selected panel.
       *
       * @param {Number} selected Selected index. Strings are converted to
       * number.
       */
      setSelectedPanel: function(selected) {
        let i = Number(selected);
        if (i === i && i < this.activeRequests.length) {
          this.selected = i;
        }
      },
      /**
       * Called when request panels `dom-repeat` renders new panel(s).
       * If there's anything to restore (from `__toRestore` property)
       * it restores it to last added panel and calls `_restoreNext()`
       * function.
       */
      _panelRendered: function() {
        if (!this.__toRestore || !this.__toRestore.requests.length) {
          return;
        }
        let next = this.__toRestore.requests.shift();
        let panel = this._getPanel(this.activeRequests.length - 1);
        panel.proxyRequest = next;
        this._restoreNext();
      },

      // A handler for "add" icon click.
      _addRequestHandler: function() {
        Polymer.RenderStatus.afterNextRender(this, () => {
          this.appendPanel();
          this.selected = this.activeRequests.length - 1;
        });
      },

      _computeTabName: function(item) {
        if (!item) {
          return 'unnamed';
        }
        if (item.name) {
          return item.name;
        }
        if (item.url) {
          return item.url;
        }
        return 'New request';
      },
      /**
       * Finds requests index in the list of active requests if the request is
       * already added to active requests.
       *
       * @param {String} requestId Saved request ID
       * @return {Number} Request index or -1 if not found.
       */
      findRequestIndex: function(requestId) {
        if (!requestId || !this.hasRequests) {
          return -1;
        }
        return this.activeRequests.findIndex(item => item._id === requestId);
      },

      _routeTabChanged: function(tab, opened) {
        if (tab === undefined || !opened || this._restoringWorkspace) {
          return;
        }
        var ar = this.activeRequests;
        if (tab === '' && this.hasRequests && this.selected >= 0) {
          return;
        }
        if (tab === 'new') {
          let id;
          try {
            id = decodeURIComponent(this.requestRoute.id);
          } catch (e) {}
          let index = this.findRequestIndex(id);
          if (index >= 0) {
            tab = index;
          } else {
            tab = ar ? ar.length : 0;
          }
        } else {
          tab = Number(tab);
          if (tab !== tab) {
            tab = 0;
          }
        }
        if (!ar || tab >= ar.length) {
          if (!this.isEmptyWorkspace(ar)) {
            this.appendPanel();
          } else {
            tab = 0;
          }
          this._openRequest(this.requestRoute, tab);
        }
        if (this.selected !== tab) {
          this.selected = tab;
        }
      },

      isEmptyWorkspace: function(activeRequests) {
        if (!activeRequests || !activeRequests.length) {
          return true;
        }
        if (activeRequests.length > 1) {
          return false;
        }
        let item = activeRequests[0];
        if (item.method === 'GET' && (!item.url || item.url === 'http://') &&
          !item.headers) {
          return true;
        }
        return false;
      },
      /**
       * Updates `tab` route property when selection change.
       */
      _selectedChanged: function(selected) {
        if (!this.requestRoute || (!selected && selected !== 0)) {
          return;
        }
        if (this._restoringWorkspace) {
          return;
        }
        if (String(selected) !== this.requestRoute.tab) {
          this.set('requestRoute.tab', selected);
          this.state.updateSelected(selected);
        }
        this._ensurePanelVisible(selected);
      },

      _ensurePanelVisible: function(index) {
        this._hideVisiblePanel();
        const selector = `#requestsContainer arc-request-panel[request-panel-id="${index}"]`;
        let panel = Polymer.dom(this.root).querySelector(selector);
        if (!panel) {
          panel = this._createPanelForIndex(index);
        }
        if (panel.hasAttribute('hidden')) {
          panel.removeAttribute('hidden');
        }
        panel.dataset.visible = true;
      },

      _hideVisiblePanel: function() {
        const selector = `arc-request-panel[data-visible]`;
        const panel = Polymer.dom(this.root).querySelector(selector);
        if (!panel) {
          return;
        }
        panel.setAttribute('hidden', true);
        delete panel.dataset.visible;
      },

      _createPanelForIndex(index) {
        const panel = document.createElement('arc-request-panel');
        panel.setAttribute('request-panel-id', index);
        const request = (this.activeRequests || [])[index];
        panel.proxyRequest = request;
        if (!this.__activeListeners) {
          this.__activeListeners = {};
        }
        const callback = function(index, e) {
          this._updateActiveRequestValue(index, e.detail.value);
        };
        this.__activeListeners[index] = callback.bind(this, index);
        panel.addEventListener('request-changed', this.__activeListeners[index]);
        Polymer.dom(this.root).querySelector('#requestsContainer')
          .appendChild(panel);
        return panel;
      },

      _updateActiveRequestValue(index, value) {
        this.activeRequests[index] = value;
      },
      /**
       * Opens a request stored in the datastore in selected `tab`.
       */
      _openRequest: function(route, tab) {
        switch (route.type) {
          case 'saved':
          case 'history':
            let id = decodeURIComponent(route.id);
            this.debounce('restore-request-' + id, function() {
              this._restoreRequestData(id, route.type, tab);
            }, 100);
            break;
        }
      },

      /**
       * Restores saved in the datastore request data.
       *
       * @param {String} id ID of the record
       * @param {String} type Type of the stored data. Can be `saved`, `history` or
       * `drive`
       * @param {Number} tab Idex of a tab where the request is restored.
       */
      _restoreRequestData: function(id, type, tab) {
        type = type || 'saved';
        var dbName;
        switch (type) {
          case 'saved':
          case 'drive':
            dbName = 'saved-requests';
            break;
          case 'history':
            dbName = 'history-requests';
            break;
          default:
            this.fire('app-log', {
              'message': `${type} is not a type of a request.`,
              'level': 'error'
            });
            console.error('Can\'t restore request data. Type is unknown.', type);
            this.fire('send-analytics', {
              type: 'exception',
              description: 'Can\'t restore request of a type: ' + type +
                ' (ArcRequestPanel)',
              fatal: true
            });
            this.$.typeMissingToast.opened = true;
            return;
        }

        var db = new PouchDB(dbName);
        return db.get(id)
        .then(request => {
          request.type = type;
          return this._setRequest(request, tab);
        })
        .catch(cause => {
          this.fire('app-log', {
            'message': cause,
            'level': 'error'
          });
          console.error('Can\'t restore request data', cause);
          this.$.missingRequestToast.opened = true;
        });
      },
      /**
       * Returns a request panel for given index.
       * @param {Number} tab Request editor tab index.
       * @return {HTMLElement} Request panel for given incdex.
       */
      _getPanel: function(tab) {
        tab++;
        return Polymer.dom(this.root)
        .querySelector('arc-request-panel:nth-child(' + tab + ')');
      },
      /**
       * Sets a request object on a given tab.
       *
       * @param {Object} request Request object to be set on the editor
       * @param {Numbewr} tab Request editor tab index.
       */
      _setRequest: function(request, tab) {
        Polymer.RenderStatus.afterNextRender(this, function() {
          var panel = this._getPanel(tab);
          panel.proxyRequest = request;
          this._updateTabs();
        });
      },
      /**
       * Handler for clost tab icon click.
       * Closes request panel.
       */
      _closeRequest: function(e) {
        e.preventDefault();
        e.stopPropagation();
        var index = Polymer.dom(e).localTarget.dataset.index;
        if (!index) {
          console.warn('Request index not found on target');
          return;
        }
        index = Number(index);
        if (index !== index) {
          console.warn('Request index is not a number');
          return;
        }
        this.splice('activeRequests', index, 1);
        if (index === this.selected) {
          index--;
        }
        if (index < 0) {
          index = 0;
        }
        if (!this.activeRequests.length) {
          Polymer.RenderStatus.afterNextRender(this, function() {
            this.appendPanel();
          });
        }
        this.selected = index;
      },

      saveOpened: function(opts) {
        var panel = this._getPanel(this.selected);
        panel.save(opts);
      },
      /**
       * Update tabs selection.
       * @return {[type]} [description]
       */
      _updateTabs: function() {
        this.$$('paper-tabs').notifyResize();
      },

      _requestsListChanged: function(record) {
        if (this._restoringWorkspace) {
          return;
        }
        switch (record.path) {
          case 'activeRequests':
          case 'activeRequests.length':
            return;
          case 'activeRequests.splices':
            if (!record.value.keySplices[0].removed.length) {
              return;
            }
        }
        this.debounce('storing-workspace-data', function() {
          this.state.updateRequestsSate(this.activeRequests);
        }, 100);
      },
      /**
       * Forces to send currently selected tab.
       */
      sendCurrent: function() {
        var panel = this._getPanel(this.selected);
        panel.sendPanel();
      },
      /**
       * Updates environment value in the state file when it's value change.
       */
      _envChanged: function(e) {
        if (e.target === this || !this.state || this._restoringWorkspace) {
          return;
        }
        const value = e.detail.value;
        this._storeEnvironmentSelection(value);
      },
      /**
       * Stores information about selected environment in the workspace
       * settings file. This is made in debouncer set to 150 ms.
       *
       * @param {String} value Environment name
       */
      _storeEnvironmentSelection: function(value) {
        if (this._restoringWorkspace) {
          return;
        }
        this.debounce('env-store-workspace', function() {
          this.state.restore()
          .then((data) => {
            if (data.environment !== value) {
              data.environment = value;
              return this.state.store(data);
            }
          });
        }, 150);
      },

      _restoreWorkspaceEnvironment: function(data) {
        if (!data || !data.environment) {
          return;
        }
        this.fire('selected-environment-changed', {
          value: data.environment
        });
      }
    });
  </script>
</dom-module>
